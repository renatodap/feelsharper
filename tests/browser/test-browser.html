<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FeelSharper Browser Test Suite</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0A0A0A;
      color: #FFFFFF;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #0B2A4A; background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
    .test-section {
      background: #1A1A1A;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .test-section h2 {
      color: #4ADE80;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .test-input {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    input, textarea {
      flex: 1;
      padding: 10px;
      background: #2A2A2A;
      border: 1px solid #444;
      color: white;
      border-radius: 4px;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      background: #0B2A4A;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
    }
    button:hover { background: #1A3A5A; }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .result {
      background: #2A2A2A;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
    }
    .success { color: #4ADE80; }
    .error { color: #EF4444; }
    .warning { color: #FFC107; }
    .info { color: #60A5FA; }
    .metric {
      display: inline-block;
      padding: 4px 8px;
      background: #2A2A2A;
      border-radius: 4px;
      margin-right: 10px;
      font-size: 14px;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #444;
      border-top-color: #4ADE80;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .test-card {
      background: #2A2A2A;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #444;
    }
    .test-card h3 {
      color: #60A5FA;
      margin-bottom: 10px;
    }
    #status-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background: #2A2A2A;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
    }
    .status-dot.online { background: #4ADE80; }
    .status-dot.error { background: #EF4444; }
  </style>
</head>
<body>
  <div id="status-indicator">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Checking...</span>
  </div>

  <h1>üöÄ FeelSharper Browser Test Suite</h1>

  <!-- Natural Language Input Test -->
  <div class="test-section">
    <h2>üß† Natural Language Input</h2>
    <div class="test-input">
      <input type="text" id="nlInput" placeholder="Try: 'weight 175' or 'ran 5k' or 'had eggs for breakfast'" value="weight 175, ran 5k, had eggs for breakfast">
      <button onclick="testNaturalLanguage()">Parse</button>
    </div>
    <div id="nlResult" class="result"></div>
  </div>

  <!-- Voice Input Test -->
  <div class="test-section">
    <h2>üé§ Voice Input</h2>
    <div class="test-input">
      <button id="voiceBtn" onclick="testVoiceInput()">Start Recording</button>
      <div id="voiceTranscript" style="flex: 1; padding: 10px; color: #999;">Click to speak...</div>
    </div>
    <div id="voiceResult" class="result"></div>
  </div>

  <!-- Image Upload Test -->
  <div class="test-section">
    <h2>üì∑ Photo Analysis</h2>
    <div class="test-input">
      <input type="file" id="photoInput" accept="image/*" onchange="testPhotoAnalysis()">
      <button onclick="document.getElementById('photoInput').click()">Upload Photo</button>
    </div>
    <div id="photoResult" class="result"></div>
  </div>

  <!-- API Health Check -->
  <div class="test-section">
    <h2>‚ö° API Performance</h2>
    <button onclick="runPerformanceTests()">Run Performance Tests</button>
    <div id="perfResult" class="result"></div>
  </div>

  <!-- Feature Tests -->
  <div class="test-section">
    <h2>‚úÖ Feature Tests</h2>
    <div class="test-grid" id="featureTests"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000/api';
    
    // Check server status
    async function checkStatus() {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      
      try {
        const res = await fetch(`${API_BASE}/health`);
        if (res.ok) {
          dot.className = 'status-dot online';
          text.textContent = 'Server Online';
        } else {
          dot.className = 'status-dot error';
          text.textContent = 'Server Error';
        }
      } catch (e) {
        dot.className = 'status-dot error';
        text.textContent = 'Server Offline';
      }
    }
    
    // Natural Language Test
    async function testNaturalLanguage() {
      const input = document.getElementById('nlInput').value;
      const result = document.getElementById('nlResult');
      
      result.innerHTML = '<div class="loading"></div> Processing...';
      
      try {
        const startTime = Date.now();
        const res = await fetch(`${API_BASE}/ai/parse`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: input, demo: true })
        });
        
        const responseTime = Date.now() - startTime;
        const data = await res.json();
        
        if (res.ok) {
          result.innerHTML = `
            <div class="success">‚úÖ Success (${responseTime}ms)</div>
            <div class="metric">Type: ${data.parsed?.type || 'unknown'}</div>
            <div class="metric">Confidence: ${(data.parsed?.confidence * 100).toFixed(0)}%</div>
            <pre>${JSON.stringify(data.parsed, null, 2)}</pre>
            ${data.coach?.message ? `<div class="info">Coach: ${data.coach.message}</div>` : ''}
          `;
        } else {
          result.innerHTML = `<div class="error">‚ùå Error: ${data.error || 'Unknown error'}</div>`;
        }
      } catch (e) {
        result.innerHTML = `<div class="error">‚ùå Failed: ${e.message}</div>`;
      }
    }
    
    // Voice Input Test
    function testVoiceInput() {
      const btn = document.getElementById('voiceBtn');
      const transcript = document.getElementById('voiceTranscript');
      const result = document.getElementById('voiceResult');
      
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        result.innerHTML = '<div class="error">‚ùå Speech recognition not supported in this browser</div>';
        return;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.lang = 'en-US';
      
      recognition.onstart = () => {
        btn.textContent = 'Listening...';
        btn.disabled = true;
        transcript.textContent = 'Listening...';
      };
      
      recognition.onresult = (event) => {
        const current = event.resultIndex;
        const transcriptText = event.results[current][0].transcript;
        transcript.textContent = transcriptText;
        
        if (event.results[current].isFinal) {
          // Parse the transcribed text
          fetch(`${API_BASE}/ai/parse`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: transcriptText, demo: true })
          })
          .then(res => res.json())
          .then(data => {
            result.innerHTML = `
              <div class="success">‚úÖ Transcribed & Parsed</div>
              <div class="info">Text: "${transcriptText}"</div>
              <div class="metric">Type: ${data.parsed?.type || 'unknown'}</div>
            `;
          });
        }
      };
      
      recognition.onerror = (event) => {
        result.innerHTML = `<div class="error">‚ùå Error: ${event.error}</div>`;
        btn.textContent = 'Start Recording';
        btn.disabled = false;
      };
      
      recognition.onend = () => {
        btn.textContent = 'Start Recording';
        btn.disabled = false;
      };
      
      recognition.start();
    }
    
    // Photo Analysis Test
    async function testPhotoAnalysis() {
      const input = document.getElementById('photoInput');
      const result = document.getElementById('photoResult');
      
      if (!input.files || !input.files[0]) return;
      
      result.innerHTML = '<div class="loading"></div> Analyzing photo...';
      
      const file = input.files[0];
      const reader = new FileReader();
      
      reader.onload = async (e) => {
        try {
          // In a real app, we'd send to /api/ai/parse-image
          // For demo, we'll simulate
          result.innerHTML = `
            <div class="success">‚úÖ Photo uploaded</div>
            <div class="info">File: ${file.name}</div>
            <div class="info">Size: ${(file.size / 1024).toFixed(2)} KB</div>
            <div class="warning">‚ö†Ô∏è Image parsing requires API configuration</div>
          `;
        } catch (e) {
          result.innerHTML = `<div class="error">‚ùå Failed: ${e.message}</div>`;
        }
      };
      
      reader.readAsDataURL(file);
    }
    
    // Performance Tests
    async function runPerformanceTests() {
      const result = document.getElementById('perfResult');
      result.innerHTML = '<div class="loading"></div> Running performance tests...';
      
      const tests = [
        { name: 'Health Check', endpoint: '/health' },
        { name: 'Parse Weight', endpoint: '/ai/parse', method: 'POST', body: { text: 'weight 175', demo: true } },
        { name: 'Parse Food', endpoint: '/ai/parse', method: 'POST', body: { text: 'chicken salad', demo: true } },
        { name: 'Parse Exercise', endpoint: '/ai/parse', method: 'POST', body: { text: 'ran 5k', demo: true } }
      ];
      
      const results = [];
      
      for (const test of tests) {
        const startTime = Date.now();
        try {
          const options = test.method === 'POST' ? {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(test.body)
          } : {};
          
          const res = await fetch(`${API_BASE}${test.endpoint}`, options);
          const responseTime = Date.now() - startTime;
          
          results.push({
            name: test.name,
            time: responseTime,
            status: res.ok ? 'success' : 'error'
          });
        } catch (e) {
          results.push({
            name: test.name,
            time: 0,
            status: 'failed'
          });
        }
      }
      
      const avgTime = results.reduce((sum, r) => sum + r.time, 0) / results.length;
      
      result.innerHTML = `
        <div class="info">Average Response Time: ${avgTime.toFixed(0)}ms</div>
        ${results.map(r => `
          <div class="${r.status === 'success' ? 'success' : 'error'}">
            ${r.status === 'success' ? '‚úÖ' : '‚ùå'} ${r.name}: ${r.time}ms
          </div>
        `).join('')}
      `;
    }
    
    // Feature Tests
    async function runFeatureTests() {
      const container = document.getElementById('featureTests');
      
      const features = [
        { name: 'Natural Language', test: () => testFeature('parse', { text: 'weight 175', demo: true }) },
        { name: 'Multi-Activity', test: () => testFeature('parse', { text: 'weight 175, ran 5k', demo: true }) },
        { name: 'Coach Response', test: () => testFeature('parse', { text: 'feeling tired', demo: true }) },
        { name: 'Database', test: () => fetch(`${API_BASE}/body-measurements?demo=true`) }
      ];
      
      for (const feature of features) {
        const card = document.createElement('div');
        card.className = 'test-card';
        card.innerHTML = `
          <h3>${feature.name}</h3>
          <div id="feature-${feature.name.replace(/\s/g, '-')}">Testing...</div>
        `;
        container.appendChild(card);
        
        try {
          const res = await feature.test();
          const resultDiv = document.getElementById(`feature-${feature.name.replace(/\s/g, '-')}`);
          if (res.ok) {
            resultDiv.innerHTML = '<div class="success">‚úÖ Working</div>';
          } else {
            resultDiv.innerHTML = '<div class="error">‚ùå Failed</div>';
          }
        } catch (e) {
          const resultDiv = document.getElementById(`feature-${feature.name.replace(/\s/g, '-')}`);
          resultDiv.innerHTML = '<div class="error">‚ùå Error</div>';
        }
      }
    }
    
    async function testFeature(endpoint, body) {
      return fetch(`${API_BASE}/ai/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
    }
    
    // Initialize
    checkStatus();
    setInterval(checkStatus, 5000);
    runFeatureTests();
  </script>
</body>
</html>